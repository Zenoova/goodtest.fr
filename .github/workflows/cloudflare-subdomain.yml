name: Cloudflare Subdomain Setup

on:
  workflow_call:
    inputs:
      subdomain:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      subdomain:
        description: Subdomain to create
        required: true
        type: string

jobs:
  cf_setup:
    name: Cloudflare Subdomain Setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup sub-domain
        run: |
          set -euo pipefail

          RESPONSE_FILE=$(mktemp)
          STATUS=$(
            curl -sS \
              -o "$RESPONSE_FILE" \
              -w "%{http_code}" \
              -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data "{\"type\":\"A\",\"name\":\"${{ inputs.subdomain }}\",\"content\":\"${{ secrets.SERVER_IP }}\",\"proxied\":true}"
          )

          echo "Cloudflare response (status $STATUS):"
          cat "$RESPONSE_FILE"

          if jq -e '.success == true' "$RESPONSE_FILE" >/dev/null; then
            exit 0
          fi

          if jq -e '.errors[]? | select(.code == 81058)' "$RESPONSE_FILE" >/dev/null; then
            echo "Record already exists; continuing."
            exit 0
          fi

          echo "Cloudflare API error; stopping workflow."
          exit 1
