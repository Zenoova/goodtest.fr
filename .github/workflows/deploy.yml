name: Build & Deploy Next.js

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  determine_subdomain:
    name: Determine Subdomain
    runs-on: ubuntu-latest
    outputs:
      subdomain: ${{ steps.subdomain.outputs.subdomain }}
    steps:
      - name: Compute subdomain
        id: subdomain
        run: |
          REPO="${{ github.event.repository.name }}"
          SUBDOMAIN="${REPO%%.*}"
          echo "subdomain=$SUBDOMAIN" >> "$GITHUB_OUTPUT"

  cpanel_git:
    name: cPanel Git Repo
    needs: determine_subdomain
    uses: ./.github/workflows/cpanel-git.yml
    with:
      subdomain: ${{ needs.determine_subdomain.outputs.subdomain }}
    secrets: inherit

  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs:
      - determine_subdomain
      - cpanel_git
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build

      - name: Compile TypeScript for server
        run: npm run tsc

      - name: Prune dev deps
        run: npm prune --omit=dev

      - name: Get runner IP
        id: ip
        if: ${{ env.ACT != 'true' && github.actor != 'nektos/act' }}
        uses: haythem/public-ip@v1.3

      - name: Whitelist IP
        if: ${{ env.ACT != 'true' && github.actor != 'nektos/act' }}
        run: |
          curl -H'Authorization: cpanel ${{ secrets.CPANEL_USERNAME }}:${{ secrets.CPANEL_API_TOKEN }}' \
          'https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/remove_all'

          curl -H'Authorization: cpanel ${{ secrets.CPANEL_USERNAME }}:${{ secrets.CPANEL_API_TOKEN }}' \
          'https://${{ secrets.CPANEL_SERVER }}:2083/execute/SshWhitelist/add?address=${{ steps.ip.outputs.ipv4 }}&port=22'

      - name: Deploy via rsync
        if: ${{ env.ACT != 'true' && github.actor != 'nektos/act' }}
        run: |
          eval $(ssh-agent -s)
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy
          chmod 400 ~/.ssh/deploy

          rsync -av --delete \
            --exclude=".next/cache" \
            --exclude=".htaccess" \
            -e "ssh -i ~/.ssh/deploy -o StrictHostKeyChecking=no" \
            . \
            ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_SERVER }}:/home2/${{ secrets.CPANEL_USERNAME }}/repositories/${{ github.event.repository.name }}

      - name: Post-deploy setup on server
        if: ${{ env.ACT != 'true' && github.actor != 'nektos/act' }}
        run: |
          ssh -i ~/.ssh/deploy -o StrictHostKeyChecking=no \
            ${{ secrets.CPANEL_USERNAME }}@${{ secrets.CPANEL_SERVER }} \
            "cd /home2/${{ secrets.CPANEL_USERNAME }}/repositories/${{ github.event.repository.name }} && npm run tsc"

      - name: Cleanup
        if: always()
        run: rm -rf ~/.ssh

  subdomains:
    name: Subdomains
    runs-on: ubuntu-latest
    if: ${{ env.ACT != 'true' && github.actor != 'nektos/act' }}
    needs:
      - deploy
      - determine_subdomain
    steps:
      - name: Create Cloudflare DNS record
        run: |
          set -euo pipefail

          RESPONSE_FILE=$(mktemp)
          STATUS=$(
            curl -sS \
              -o "$RESPONSE_FILE" \
              -w "%{http_code}" \
              -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/dns_records" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data "{\"type\":\"A\",\"name\":\"${{ needs.determine_subdomain.outputs.subdomain }}\",\"content\":\"${{ secrets.SERVER_IP }}\",\"proxied\":true}"
          )

          echo "Cloudflare response (status $STATUS):"
          cat "$RESPONSE_FILE"

          if jq -e '.success == true' "$RESPONSE_FILE" >/dev/null; then
            exit 0
          fi

          if jq -e '.errors[]? | select(.code == 81058)' "$RESPONSE_FILE" >/dev/null; then
            echo "Record already exists; continuing."
            exit 0
          fi

          echo "Cloudflare API error; stopping workflow."
          exit 1

      - name: Create cPanel subdomain
        run: |
          set -euo pipefail

          ROOT_DOMAIN="zenoova.com"
          DOC_ROOT="repositories/${{ github.event.repository.name }}"

          RESPONSE_FILE=$(mktemp)
          STATUS=$(
            curl -sS \
              -o "$RESPONSE_FILE" \
              -w "%{http_code}" \
              -H "Authorization: cpanel ${{ secrets.CPANEL_USERNAME }}:${{ secrets.CPANEL_API_TOKEN }}" \
              "https://${{ secrets.CPANEL_SERVER }}:2083/execute/SubDomain/addsubdomain?domain=${{ needs.determine_subdomain.outputs.subdomain }}&rootdomain=${ROOT_DOMAIN}&dir=${DOC_ROOT}"
          )

          echo "cPanel response (status $STATUS):"
          cat "$RESPONSE_FILE"

          if jq -e '.status == 1' "$RESPONSE_FILE" >/dev/null; then
            exit 0
          fi

          if jq -e '.errors[]? | contains("already exists") or contains("DNS existe")' "$RESPONSE_FILE" >/dev/null; then
            echo "Subdomain already exists; continuing."
            exit 0
          fi

          echo "cPanel API error; stopping workflow."
          exit 1
